#!/bin/bash

set -u
set -e

function install_puppet() {
    # FIXME: This is DTAG specific. Introduce a hook for this.
    wget http://mirror1/puppetlabs-release-precise.deb
    dpkg -i puppetlabs-release-precise.deb
    rm puppetlabs-release-precise.deb
    cat >/etc/apt/sources.list.d/puppetlabs.list <<EOFPUPPETLABSLIST
deb [arch=amd64] http://mirror1/apt.puppetlabs.com/ precise main dependencies
EOFPUPPETLABSLIST

    apt-get update || true;
    apt-get -y install puppet puppet-common

# Do not go with GEM installed puppet agent -gollub
#    gem install puppet --no-ri --no-rdoc <%= "--version #{@options[:version]}" if @options[:version] && !@options[:version].empty? %>
#    puppet master --mkusers
}

function configure_puppet() {
    mkdir -p /etc/puppet
    cat >/etc/puppet/puppet.conf <<EOFPUPPETCONF
[main]
logdir = /var/log/puppet
rundir = /var/run/puppet
vardir = /var/lib/puppet
ssldir = /var/lib/puppet/ssl
pluginsync = true
report = true
<%= "ca_server = #{@options[:ca_server]}" if @options[:ca_server] && !@options[:ca_server].empty? %>
<%= "server = #{@options[:server]}" if @options[:server] && !@options[:server].empty? %>
# we need to have the FQDN name here - required for puppet-secret -gollub
#certname = <%= @options[:puppetagent_certname] %>
EOFPUPPETCONF

    if [ -f /etc/default/puppet ]; then
        cat > /etc/default/puppet <<EOFPUPPETDEFAULT
# Defaults for puppet - sourced by /etc/init.d/puppet

# Start puppet on boot?
START=yes

# Startup options
DAEMON_OPTS=''
EOFPUPPETDEFAULT
    fi
}

function run_agent() {
    ## DTAG specific "stage1". TODO: make configurable -gollub

    puppet agent --environment stage1 -t --noop
    # Force environtment change by stopping the running agent
    service puppet stop
    # ... and run onetime daemonized
    # Daemonized run is required since we loose the connection
    # via SSH since the network might get reconfigured and retartd.
    puppet agent --environment stage1 -o
}

#This fuction is not called if no custom facts are given
#
# The Puppet Labs stdlib module is required for this to work
#It can be installed using:
# puppet-module install puppetlabs/stdlib
function facts_dot_d() {
    mkdir -p /etc/facter/facts.d
    <% if @options[:metadata] %>
        echo Installing custom facts
        <% @options[:metadata].each do |fact,value| %>
            <% if value && !value.empty? %>
                echo '<%= fact %>=<%= value %>' > /etc/facter/facts.d/<%= fact %>.txt
            <% end %>
        <% end %>
    <% end %>
}

function provision_puppet() {
    install_puppet
    configure_puppet
    <%= 'facts_dot_d' if @options[:metadata] %>
    run_agent
    echo Puppet installation finished!
    exit 0
}

provision_puppet
